---
title: "Precompute Vignette Data"
output: html_document
---

```{r precompute_setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(rmarkdown)
devtools::load_all()

# Create the file here, in the setup
VIGNETTE_PATH <- "../vignettes"
DATA_DIR <- file.path(VIGNETTE_PATH, "data")
FIGURES_DIR <- file.path(VIGNETTE_PATH, "figures")
VIGNETTE_FILE <- file.path(VIGNETTE_PATH, "example_import.Rmd")
file.create(VIGNETTE_FILE)
```

```{r generate_data_plot}
# Define the actual code as strings
basic_code <- 'basic_example <- wp_data(
  ISO = "USA",
  formula = "100*CU_C/GDP_C",
  years = c(2000, 2002)
)'

advanced_code <- 'advanced_example <- wp_data(
  ISO = c("CHN", "JPN"),
  formula = c("EXg_C/GDP_C"),
  years = c(2010, 2012)
)'

write_md <- function(text) {
  cat(text, "\n", file = VIGNETTE_FILE, append = TRUE)
}

save_data_code <- function(data, filename) {
  dump_code <- paste(
    sprintf("%s <- structure(", filename),
    paste(deparse(data), collapse="\n"),
    ")",
    sep = "\n"
  )
  writeLines(dump_code, file.path(DATA_DIR, paste0(filename, ".R")))
}

# Execute the code strings to create the data
eval(parse(text = basic_code))
eval(parse(text = advanced_code))

# Save the generated data
save_data_code(basic_example, "basic_example")
save_data_code(advanced_example, "advanced_example")

# Generate plots
wp_plot_series(basic_example, filename = file.path(FIGURES_DIR, "basic_plot"))
wp_plot_bar(advanced_example, filename = file.path(FIGURES_DIR, "advanced_plot"))
```


<!-- ########################## GENERATE THE VIGNETTE ########################## -->


```{r generate_vignette}
# Write YAML header
write_md('---
title: "Introduction to WPD"
output: rmarkdown::html_vignette
vignette: >
  %\\VignetteIndexEntry{Introduction to WPD}
  %\\VignetteEngine{knitr::rmarkdown}
  %\\VignetteEncoding{UTF-8}
---

# Write setup chunk
\```{r setup, include=FALSE}
library(WPD)
# Load precomputed data
source("data/basic_example.R")
source("data/advanced_example.R")
\```')


##################################################################################
# Write basic analysis section
write_md(sprintf('## Basic Analysis: Single Country Example

To analyze a country\'s economic indicators, start with a simple example. Here\'s how to calculate the US current account as a percentage of GDP:

\```{r basic_example_code, eval=FALSE}
%s
\```

This returns a data frame with the results:

\```{r show_basic_results}
head(basic_example)
\```

We can visualize this data using `wp_plot_series()`:

\```{r basic_plot_code, eval=FALSE}
wp_plot_series(basic_example)
\```

![Basic Time Series Plot](figures/basic_plot.png)', basic_code))



##################################################################################
# Write advanced analysis section
write_md('## Advanced Analysis: Multiple Countries

For comparative analysis, we can examine multiple countries. Let\'s look at export ratios for China and Japan:

\```{r advanced_example_code, eval=FALSE}')
write_md(advanced_code)
write_md('\```

Here\'s the resulting data:

\```{r show_advanced_results}
head(advanced_example)
\```

We can create a bar plot to compare these values:

\```{r advanced_plot_code, eval=FALSE}
wp_plot_bar(advanced_example)
\```

![Advanced Bar Plot](figures/advanced_plot.png)')
```

```{r validate}
# Validation checks
required_files <- c(
  file.path(DATA_DIR, "basic_example.R"),
  file.path(DATA_DIR, "advanced_example.R"),
  file.path(FIGURES_DIR, "basic_plot.png"),
  file.path(FIGURES_DIR, "advanced_plot.png"),
  VIGNETTE_FILE
)

missing_files <- required_files[!file.exists(required_files)]

if (length(missing_files) > 0) {
  stop("Missing files: ", paste(missing_files, collapse = ", "))
}
```

